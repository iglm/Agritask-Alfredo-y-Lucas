rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- Helper Functions ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return request.auth.uid == userId; }
    // Checks owner on an existing document for read/delete operations
    function isExistingDocOwner() { return isSignedIn() && resource.data.userId == request.auth.uid; }
    // Checks owner on a new/updated document for write operations
    function isNewDocOwner() { return isSignedIn() && request.resource.data.userId == request.auth.uid; }

    // --- User Profile ---
    match /users/{userId} {
      // Users can only read and write their own profile
      allow read, write: if isOwner(userId);
    }

    // --- User Data Collections ---
    // These rules enforce that a user can only read/write documents they own.
    match /lots/{lotId} {
      allow read, write: if isExistingDocOwner() || isNewDocOwner();
      match /sublots/{sublotId} {
        allow read, write: if isExistingDocOwner() || isNewDocOwner();
      }
    }

    match /tasks/{taskId} {
      allow read, write: if isExistingDocOwner() || isNewDocOwner();
      match /supplyUsages/{usageId} {
        allow read, write: if isExistingDocOwner() || isNewDocOwner();
      }
    }

    match /productiveUnits/{docId} { allow read, write: if isExistingDocOwner() || isNewDocOwner(); }
    match /staff/{docId} { allow read, write: if isExistingDocOwner() || isNewDocOwner(); }
    match /staffAttendance/{docId} { allow read, write: if isExistingDocOwner() || isNewDocOwner(); }
    match /supplies/{docId} { allow read, write: if isExistingDocOwner() || isNewDocOwner(); }
    match /transactions/{docId} { allow read, write: if isExistingDocOwner() || isNewDocOwner(); }

    // --- Collection Group Queries ---
    // This allows `collectionGroup('supplyUsages').where('userId', '==', ...)`
    // This rule is crucial and must exist for collection group queries to work.
    match /{path=**}/supplyUsages/{usageId} {
      allow read: if isExistingDocOwner();
    }
    
    // --- System Logs ---
    match /system_logs/{logId} {
      allow create: if isNewDocOwner();
      allow read: if isExistingDocOwner();
      allow update, delete: if false;
    }
  }
}
